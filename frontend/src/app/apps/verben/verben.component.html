<app-learning-app-layout title="‚úçÔ∏è Verben-Quiz" appId="verben" [content]="currentRound()">
    <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progress()"></div>
    </div>

    <div class="card">
        <!-- ‚ïê‚ïê‚ïê WELCOME ‚ïê‚ïê‚ïê -->
        @if (screen() === 'welcome') {
        <div class="welcome-container">
            <div class="welcome-emoji">‚úçÔ∏è</div>
            <h2>Verben-Quiz</h2>

            <div class="mode-selector">
                @for (m of modes; track m.id) {
                @if (!m.minLevel || userLevel() >= m.minLevel) {
                <button class="mode-btn" [class.active]="mode() === m.id" (click)="setMode(m.id)">
                    <span class="mode-icon">{{ m.icon }}</span>
                    <span class="mode-label">{{ m.label }}</span>
                    <span class="mode-desc">{{ m.description }}</span>
                </button>
                } @else {
                <button class="mode-btn locked" disabled>
                    <span class="mode-icon">üîí</span>
                    <span class="mode-label">{{ m.label }}</span>
                    <span class="mode-desc">Ab Stufe {{ m.minLevel }}</span>
                </button>
                }
                }
            </div>

            @if (mode() === 'fehlerfinden') {
            <div class="difficulty-selector">
                <span class="difficulty-label">Schwierigkeit:</span>
                <div class="difficulty-buttons">
                    <button class="diff-btn" [class.active]="fehlerDifficulty() === 'easy'"
                        (click)="setFehlerDifficulty('easy')">
                        <span class="diff-icon">üü¢</span> Einfach
                    </button>
                    <button class="diff-btn" [class.active]="fehlerDifficulty() === 'medium'"
                        (click)="setFehlerDifficulty('medium')">
                        <span class="diff-icon">üü°</span> Mittel
                    </button>
                    <button class="diff-btn" [class.active]="fehlerDifficulty() === 'hard'"
                        (click)="setFehlerDifficulty('hard')">
                        <span class="diff-icon">üî¥</span> Schwer
                    </button>
                </div>
            </div>
            }

            <button class="btn btn-primary" (click)="startQuiz()" [disabled]="verbs().length === 0">
                Quiz starten
            </button>
        </div>
        }

        <!-- ‚ïê‚ïê‚ïê QUIZ: KONJUGATION ‚ïê‚ïê‚ïê -->
        @if (screen() === 'quiz' && mode() === 'konjugation') {
        <div class="quiz-content">
            <div class="round-info">Runde {{ currentRoundIndex() + 1 }} / 5</div>

            <div class="question-list">
                @for (q of currentRound(); track $index) {
                <div class="question-item">
                    <div class="question-label">
                        <span class="verb-badge">{{ q.verb }}</span>
                        <span class="person-badge">{{ q.person }}</span>
                        <span class="tense-badge">{{ tenseNames[q.tense] }}</span>
                    </div>
                    <input type="text" class="answer-input" [class.correct]="answered() && q.isCorrect"
                        [class.incorrect]="answered() && !q.isCorrect" [value]="roundAnswers()[$index]"
                        (input)="updateAnswer($index, $any($event.target).value)" [disabled]="answered()"
                        placeholder="Antwort eingeben..." autocomplete="off">
                    @if (answered() && !q.isCorrect) {
                    <div class="correction">Richtig: {{ q.answer }}</div>
                    }
                </div>
                }
            </div>

            @if (!answered()) {
            <button class="btn btn-primary" (click)="checkAnswers()">√úberpr√ºfen</button>
            } @else {
            <button class="btn btn-primary" (click)="nextRound()">Weiter</button>
            }
        </div>
        }

        <!-- ‚ïê‚ïê‚ïê QUIZ: ZEITFORM ‚ïê‚ïê‚ïê -->
        @if (screen() === 'quiz' && mode() === 'zeitform') {
        <div class="quiz-content">
            <div class="round-info">Frage {{ currentTenseIndex() + 1 }} / {{ totalQuestions() }}</div>

            @if (currentTenseQuestion(); as q) {
            <div class="tense-question">
                <div class="conjugated-display">
                    <span class="person-badge">{{ q.person }}</span>
                    <span class="conjugated-form">{{ q.conjugated }}</span>
                </div>
                <p class="tense-prompt">Welche Zeitform ist das?</p>
                <div class="tense-options">
                    @for (opt of q.options; track opt) {
                    <button class="tense-option-btn" [class.selected]="q.selectedOption === opt"
                        [class.correct]="tenseAnswered() && opt === q.correctTense"
                        [class.incorrect]="tenseAnswered() && q.selectedOption === opt && opt !== q.correctTense"
                        [disabled]="tenseAnswered()" (click)="selectTense(opt)">
                        {{ tenseNames[opt] }}
                    </button>
                    }
                </div>
            </div>

            @if (tenseAnswered()) {
            <div class="feedback-row">
                @if (q.isCorrect) {
                <span class="feedback correct">‚úì Richtig!</span>
                } @else {
                <span class="feedback incorrect">‚úó Es war: {{ tenseNames[q.correctTense] }}</span>
                }
            </div>
            <button class="btn btn-primary" (click)="nextTenseQuestion()">Weiter</button>
            }
            }
        </div>
        }

        <!-- ‚ïê‚ïê‚ïê QUIZ: MULTIPLE CHOICE ‚ïê‚ïê‚ïê -->
        @if (screen() === 'quiz' && mode() === 'multiplechoice') {
        <div class="quiz-content">
            <div class="round-info">Frage {{ currentMCIndex() + 1 }} / {{ totalQuestions() }}</div>

            @if (currentMCQuestion(); as q) {
            <div class="mc-question">
                <div class="question-label">
                    <span class="verb-badge">{{ q.verb }}</span>
                    <span class="person-badge">{{ q.person }}</span>
                    <span class="tense-badge">{{ tenseNames[q.tense] }}</span>
                </div>
                <div class="mc-options">
                    @for (opt of q.options; track $index) {
                    <button class="mc-option-btn" [class.selected]="opt.selected"
                        [class.correct]="mcAnswered() && opt.isCorrect"
                        [class.incorrect]="mcAnswered() && opt.selected && !opt.isCorrect" [disabled]="mcAnswered()"
                        (click)="selectMCOption($index)">
                        {{ opt.text }}
                    </button>
                    }
                </div>
            </div>

            @if (mcAnswered()) {
            <div class="feedback-row">
                @if (q.isCorrect) {
                <span class="feedback correct">‚úì Richtig!</span>
                } @else {
                <span class="feedback incorrect">‚úó Richtig w√§re: {{ q.correctAnswer }}</span>
                }
            </div>
            <button class="btn btn-primary" (click)="nextMCQuestion()">Weiter</button>
            }
            }
        </div>
        }

        <!-- ‚ïê‚ïê‚ïê QUIZ: FEHLER FINDEN ‚ïê‚ïê‚ïê -->
        @if (screen() === 'quiz' && mode() === 'fehlerfinden') {
        <div class="quiz-content">
            <div class="round-info">Frage {{ currentFehlerIndex() + 1 }} / {{ totalQuestions() }}</div>

            @if (currentFehlerQuestion(); as q) {
            <div class="fehler-question">
                <div class="fehler-header">
                    <span class="verb-badge">{{ q.verb }}</span>
                    <span class="tense-badge">{{ tenseNames[q.tense] }}</span>
                </div>

                @if (fehlerDifficulty() === 'hard') {
                <!-- Hard mode: single form with Richtig/Falsch -->
                <p class="fehler-prompt">ü§î Ist diese Form richtig?</p>
                <div class="hard-display">
                    <span class="hard-person">{{ q.options[0].person }}</span>
                    <span class="hard-form">{{ q.options[0].form }}</span>
                </div>
                <div class="hard-buttons">
                    <button class="hard-btn richtig" [class.selected]="q.hardAnswer === 'richtig'"
                        [class.correct]="fehlerAnswered() && q.isCorrectForm"
                        [class.incorrect]="fehlerAnswered() && q.hardAnswer === 'richtig' && !q.isCorrectForm"
                        [disabled]="fehlerAnswered()" (click)="selectFehlerHardOption('richtig')">
                        ‚úì Richtig
                    </button>
                    <button class="hard-btn falsch" [class.selected]="q.hardAnswer === 'falsch'"
                        [class.correct]="fehlerAnswered() && !q.isCorrectForm"
                        [class.incorrect]="fehlerAnswered() && q.hardAnswer === 'falsch' && q.isCorrectForm"
                        [disabled]="fehlerAnswered()" (click)="selectFehlerHardOption('falsch')">
                        ‚úó Falsch
                    </button>
                </div>
                } @else {
                <!-- Easy / Medium mode: option list -->
                <p class="fehler-prompt">üîç Welche Form ist falsch?</p>
                <div class="fehler-options">
                    @for (opt of q.options; track $index) {
                    <button class="fehler-option-btn" [class.selected]="opt.selected"
                        [class.is-mistake]="fehlerAnswered() && opt.isMistake"
                        [class.correct-pick]="fehlerAnswered() && opt.selected && opt.isMistake"
                        [class.wrong-pick]="fehlerAnswered() && opt.selected && !opt.isMistake"
                        [class.safe]="fehlerAnswered() && !opt.isMistake && !opt.selected" [disabled]="fehlerAnswered()"
                        (click)="selectFehlerOption($index)">
                        <span class="fehler-person">{{ opt.person }}</span>
                        <span class="fehler-form">{{ opt.form }}</span>
                    </button>
                    }
                </div>
                }
            </div>

            @if (fehlerAnswered()) {
            <div class="feedback-row">
                @if (q.isCorrect) {
                @if (fehlerDifficulty() === 'hard') {
                <span class="feedback correct">‚úì Richtig! Die Form ¬´{{ q.options[0].form }}¬ª ist {{ q.isCorrectForm ?
                    'korrekt' : 'falsch' }}.</span>
                } @else {
                <span class="feedback correct">‚úì Richtig! ¬´{{ q.mistakeForm }}¬ª ist falsch.</span>
                }
                } @else {
                @if (fehlerDifficulty() === 'hard') {
                <span class="feedback incorrect">‚úó Die Form ¬´{{ q.options[0].form }}¬ª ist {{ q.isCorrectForm ? 'korrekt'
                    : 'falsch' }}. Richtig: {{ q.correctForm }}</span>
                } @else {
                <span class="feedback incorrect">‚úó ¬´{{ q.mistakePerson }}: {{ q.mistakeForm }}¬ª war der Fehler. Richtig:
                    {{ q.correctForm }}</span>
                }
                }
            </div>
            <button class="btn btn-primary" (click)="nextFehlerQuestion()">Weiter</button>
            }
            }
        </div>
        }

        <!-- ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê -->
        @if (screen() === 'results') {
        <div class="score-display">
            <div class="score-circle">{{ percentage() }}%</div>
            <p class="score-text">{{ totalCorrect() }} von {{ totalQuestions() }} richtig!</p>
            <div class="score-breakdown">
                <div class="score-item correct">
                    <div class="score-item-number">{{ totalCorrect() }}</div>
                    <div class="score-item-label">Richtig</div>
                </div>
                <div class="score-item wrong">
                    <div class="score-item-number">{{ totalQuestions() - totalCorrect() }}</div>
                    <div class="score-item-label">Falsch</div>
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 30px;" (click)="startQuiz()">
                Weiter √ºben
            </button>
            <button class="btn btn-secondary" style="margin-top: 10px;" (click)="restartQuiz()">
                Zur√ºck
            </button>
        </div>
        }
    </div>
</app-learning-app-layout>