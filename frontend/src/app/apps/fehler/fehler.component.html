<app-learning-app-layout title="üîç Fehler finden" appId="fehler" [content]="texts()[currentTextIndex()]">
    <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progress()"></div>
    </div>

    <div class="card">
        <!-- Welcome Screen -->
        @if (screen() === 'welcome') {
        <div class="welcome-container">
            <div class="welcome-emoji">üìù</div>
            <h2 style="margin-bottom: 12px;">Finde die Fehler!</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px; max-width: 300px;">
                Lies den Text und klicke auf falsch geschriebene W√∂rter. Schreibe dann die korrekte Version.
            </p>
            <div class="mode-selector">
                @for (m of modes; track m.id) {
                <button class="mode-btn" [class.active]="mode() === m.id" (click)="setMode(m.id)">
                    <span class="mode-icon">{{ m.icon }}</span>
                    <span class="mode-label">{{ m.label }}</span>
                    <span class="mode-desc">{{ m.description }}</span>
                </button>
                }
            </div>
            <button class="btn btn-primary" (click)="startQuiz()" [disabled]="!dataLoaded()">Starten</button>
        </div>
        }

        <!-- Quiz Screen: Korrektur -->
        @if (screen() === 'quiz' && mode() === 'korrektur') {
        <div class="quiz-content">
            <div class="stats-bar">
                <span>Text <strong>{{ currentTextIndex() + 1 }}</strong> von <strong>{{ texts().length
                        }}</strong></span>
            </div>

            <div class="text-display">
                @for (word of displayWords(); track word.wordIndex) {
                <span class="word" [class]="getWordClass(word)"
                    [attr.data-correction]="checked() ? getRevealedCorrection(word) : getWordCorrection(word)"
                    (click)="openCorrectionPopup(word)">{{ word.text }}</span>{{ ' ' }}
                }
            </div>

            <div class="actions">
                @if (!checked()) {
                <button class="btn btn-hint" (click)="showHint()">üí° Hinweis</button>
                <button class="btn btn-check" (click)="checkText()">√úberpr√ºfen</button>
                } @else {
                <button class="btn btn-primary" (click)="nextText()">Weiter</button>
                }
            </div>
        </div>
        }

        <!-- Quiz Screen: Markieren -->
        @if (screen() === 'quiz' && mode() === 'markieren') {
        <div class="quiz-content">
            <div class="stats-bar">
                <span>Text <strong>{{ currentTextIndex() + 1 }}</strong> von <strong>{{ texts().length }}</strong></span>
            </div>

            <p class="hunt-instruction">Klicke auf die falsch geschriebenen W√∂rter!</p>

            <div class="text-display">
                @for (word of displayWords(); track word.wordIndex) {
                <span class="word" [class]="getHighlightClass(word)"
                    (click)="toggleHighlight(word)">{{ word.text }}</span>{{ ' ' }}
                }
            </div>

            <div class="actions">
                @if (!checked()) {
                <button class="btn btn-hint" (click)="showHint()">üí° Hinweis</button>
                <button class="btn btn-check" (click)="checkHighlight()">√úberpr√ºfen</button>
                } @else {
                <button class="btn btn-primary" (click)="nextText()">Weiter</button>
                }
            </div>
        </div>
        }

        <!-- Results Screen -->
        @if (screen() === 'results') {
        <div class="score-display">
            <div class="score-circle">{{ percentage() }}%</div>
            <div class="score-text">Fehler gefunden</div>
            <div class="score-breakdown">
                <div class="score-item correct">
                    <div class="score-item-number">{{ totalFound() }}</div>
                    <div class="score-item-label">Gefunden</div>
                </div>
                <div class="score-item wrong">
                    <div class="score-item-number">{{ totalMissed() }}</div>
                    <div class="score-item-label">Verpasst</div>
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 30px;" (click)="startQuiz()">
                Weiter √ºben
            </button>
            <button class="btn btn-secondary" style="margin-top: 10px;" (click)="restartQuiz()">
                Zur√ºck
            </button>
        </div>
        }
    </div>

    <!-- Correction Popup -->
    @if (showPopup()) {
    <div class="popup-overlay visible" (click)="closePopup()">
        <div class="popup" (click)="$event.stopPropagation()">
            <div class="popup-title">Wie schreibt man das richtig?</div>
            <div class="popup-input-container">
                <div class="popup-word-display">{{ popupWordText() }}</div>
                <input type="text" class="popup-input" [(ngModel)]="correctionInput"
                    placeholder="Korrekte Schreibweise..." (keydown.enter)="submitCorrection()"
                    (keydown.escape)="closePopup()">
                <div class="popup-buttons">
                    <button class="popup-btn-cancel" (click)="closePopup()">Abbrechen</button>
                    <button class="popup-btn-submit" (click)="submitCorrection()">√úbernehmen</button>
                </div>
            </div>
        </div>
    </div>
    }
</app-learning-app-layout>