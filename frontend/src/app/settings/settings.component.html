<div class="settings-container">
    <header class="settings-header">
        <button class="back-btn" (click)="goBack()">
            ‚Üê Zur√ºck
        </button>
        <h1>‚öôÔ∏è Einstellungen</h1>
    </header>

    @if (!authService.isAuthenticated()) {
    <div class="auth-warning">
        <p>‚ö†Ô∏è Du musst angemeldet sein, um dein Profil zu bearbeiten.</p>
        <button class="primary-btn" (click)="goBack()">Zur Startseite</button>
    </div>
    } @else {
    <div class="settings-content">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn" [class.active]="activeTab() === 'profile'" (click)="setTab('profile')">
                üë§ Profil
            </button>
            <button class="tab-btn" [class.active]="activeTab() === 'avatar'" (click)="setTab('avatar')">
                üé® Avatar
            </button>
            <button class="tab-btn" [class.active]="activeTab() === 'learning'" (click)="setTab('learning')">
                üìö Lernen
            </button>
        </div>

        <!-- Profile Tab -->
        @if (activeTab() === 'profile') {
        <div class="tab-content">
            <div class="profile-section">
                <!-- ... existing profile content ... -->
                <div class="avatar-preview-large">
                    @if (profileAvatarSvgSafe()) {
                    <div class="avatar-image" [innerHTML]="profileAvatarSvgSafe()"></div>
                    } @else if (authService.user()?.photoURL) {
                    <img [src]="authService.user()?.photoURL" alt="Avatar">
                    } @else {
                    <div class="avatar-placeholder">
                        {{ (displayName() || authService.user()?.email)?.charAt(0)?.toUpperCase() }}
                    </div>
                    }
                </div>

                <div class="form-group">
                    <label for="displayName">Anzeigename</label>
                    <input type="text" id="displayName" [ngModel]="displayName()"
                        (ngModelChange)="displayName.set($event)" placeholder="Dein Name" maxlength="50">
                    <span class="hint">Dieser Name wird in der App angezeigt</span>
                </div>

                <div class="form-group">
                    <label for="language">Sprache</label>
                    <select id="language" [ngModel]="languageVariant()" (ngModelChange)="languageVariant.set($event)"
                        style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--surface-border); background: var(--surface-card); color: var(--text-color); font-size: 1rem;">
                        <option value="swiss">Schweizerdeutsch üá®üá≠</option>
                        <option value="standard">Hochdeutsch üá©üá™</option>
                    </select>
                    <span class="hint">Bevorzugte Sprache f√ºr KI-Aufgaben</span>
                </div>

                <div class="form-group readonly">
                    <label>E-Mail</label>
                    <input type="text" [value]="authService.user()?.email" readonly disabled>
                </div>

                <div class="form-group readonly">
                    <label>Anmeldemethode</label>
                    <input type="text" [value]="authService.user()?.provider === 'google' ? 'Google' : 'E-Mail'"
                        readonly disabled>
                </div>
            </div>
        </div>
        }

        <!-- Avatar Tab -->
        @if (activeTab() === 'avatar') {
        <div class="tab-content">
            <div class="avatar-editor">
                <!-- ... existing avatar content ... -->
                <div class="avatar-preview-section">
                    <div class="avatar-preview-large">
                        <div class="avatar-image" [innerHTML]="avatarSvgSafe()"></div>
                    </div>
                    <button class="randomize-btn" (click)="randomizeAvatar()">
                        üé≤ Zuf√§llig
                    </button>
                </div>

                <!-- Customization Options -->
                <div class="avatar-options">
                    <!-- Background Color -->
                    <div class="option-group">
                        <label>Hintergrund</label>
                        <div class="color-options">
                            @for (color of backgroundColors; track color) {
                            <button class="color-btn" [style.background]="color"
                                [class.active]="avatarConfig().backgroundColor === color"
                                (click)="updateAvatarPart('backgroundColor', color)">
                            </button>
                            }
                        </div>
                    </div>
                    <!-- ... other avatar options ... -->
                    <!-- Skin Tone -->
                    <div class="option-group">
                        <label>Hautfarbe</label>
                        <div class="color-options">
                            @for (tone of skinTones; track tone) {
                            <button class="color-btn" [style.background]="tone"
                                [class.active]="avatarConfig().skinTone === tone"
                                (click)="updateAvatarPart('skinTone', tone)">
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Hair Style -->
                    <div class="option-group">
                        <label>Frisur</label>
                        <div class="style-options">
                            @for (style of hairStyles; track style.id) {
                            <button class="style-btn" [class.active]="avatarConfig().hairStyle === style.id"
                                (click)="updateAvatarPart('hairStyle', style.id)">
                                {{ style.text }}
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Hair Color -->
                    <div class="option-group">
                        <label>Haarfarbe</label>
                        <div class="color-options">
                            @for (color of hairColors; track color) {
                            <button class="color-btn" [style.background]="color"
                                [class.active]="avatarConfig().hairColor === color"
                                (click)="updateAvatarPart('hairColor', color)">
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Eyes -->
                    <div class="option-group">
                        <label>Augen</label>
                        <div class="style-options">
                            @for (style of eyeStyles; track style.id) {
                            <button class="style-btn" [class.active]="avatarConfig().eyes === style.id"
                                (click)="updateAvatarPart('eyes', style.id)">
                                {{ style.text }}
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Eyebrows -->
                    <div class="option-group">
                        <label>Augenbrauen</label>
                        <div class="style-options">
                            @for (style of eyebrowStyles; track style.id) {
                            <button class="style-btn" [class.active]="avatarConfig().eyebrows === style.id"
                                (click)="updateAvatarPart('eyebrows', style.id)">
                                {{ style.text }}
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Mouth -->
                    <div class="option-group">
                        <label>Mund</label>
                        <div class="style-options">
                            @for (style of mouthStyles; track style.id) {
                            <button class="style-btn" [class.active]="avatarConfig().mouth === style.id"
                                (click)="updateAvatarPart('mouth', style.id)">
                                {{ style.text }}
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Accessories -->
                    <div class="option-group">
                        <label>Accessoires</label>
                        <div class="style-options">
                            @for (option of accessoryOptions; track option.id) {
                            <button class="style-btn" [class.active]="avatarConfig().accessories === option.id"
                                (click)="updateAvatarPart('accessories', option.id)">
                                {{ option.text }}
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Facial Hair -->
                    <div class="option-group">
                        <label>Bart</label>
                        <div class="style-options">
                            @for (option of facialHairOptions; track option.id) {
                            <button class="style-btn" [class.active]="avatarConfig().facialHair === option.id"
                                (click)="updateAvatarPart('facialHair', option.id)">
                                {{ option.text }}
                            </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }

        <!-- Learning Tab -->
        @if (activeTab() === 'learning') {
        <div class="tab-content">
            @if (optedOut()) {
            <div class="auth-warning">
                <p>‚ö†Ô∏è Du hast personifizierte Lernvorschl√§ge deaktiviert.</p>
                <p style="font-size: 1rem; color: var(--text-secondary);">Aktiviere sie, um Aufgaben zu erhalten, die
                    genau zu deinem Schulniveau passen.</p>
                <button class="primary-btn" (click)="toggleOptOut(false)">Einstellungen aktivieren</button>
            </div>
            } @else {
            <div class="learning-options">
                <div class="section-header">
                    <h2>Lernniveau</h2>
                    <button class="text-btn small-btn" (click)="toggleOptOut(true)"
                        title="Daten l√∂schen und deaktivieren">
                        üóëÔ∏è Deaktivieren
                    </button>
                </div>

                <!-- Skill Level -->
                <div class="option-group">
                    <label>Deine Einsch√§tzung</label>
                    <div class="slider-container">
                        <input type="range" min="0" max="1" step="0.1" [ngModel]="skillLevel()"
                            (ngModelChange)="skillLevel.set($event)" class="range-slider">
                        <div class="slider-labels">
                            <span>Anf√§nger</span>
                            <span>Profi</span>
                        </div>
                    </div>
                </div>

                <!-- School Type -->
                <div class="option-group">
                    <label>Schulstufe</label>
                    <div class="style-options">
                        @for (type of schoolTypes; track type.id) {
                        <button class="style-btn" [class.active]="schoolType() === type.id"
                            (click)="updateSchoolType(type.id)">
                            {{ type.text }}
                        </button>
                        }
                    </div>
                </div>

                <!-- Grade -->
                <div class="option-group">
                    <label>Klasse / Stufe</label>
                    <div class="style-options">
                        @for (g of gradesForType; track g) {
                        <button class="style-btn" [class.active]="grade() === g" (click)="updateGrade(g)">
                            {{ g }}
                        </button>
                        }
                    </div>
                </div>
            </div>
            }
        </div>
        }

        <!-- Save Button -->
        <div class="actions">
            @if (saveSuccess()) {
            <div class="success-message">‚úÖ Profil gespeichert!</div>
            }
            @if (saveError()) {
            <div class="error-message">‚ùå {{ saveError() }}</div>
            }
            <button class="save-btn" (click)="saveProfile()" [disabled]="saving()">
                @if (saving()) {
                Speichern...
                } @else {
                üíæ Profil speichern
                }
            </button>
        </div>
    </div>
    }
</div>