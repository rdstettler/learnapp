<div class="editor-container">
    <header class="editor-header">
        <button class="back-btn" (click)="goBack()">‚Üê Zur√ºck</button>
        <h1>üì¶ Inhalte verwalten</h1>
    </header>

    <!-- App Selector -->
    <div class="app-selector">
        <label>App w√§hlen:</label>
        <div class="app-chips">
            @for (app of apps(); track app.id) {
            <button class="app-chip"
                    [class.active]="selectedAppId() === app.id"
                    (click)="selectApp(app.id)">
                {{ app.icon }} {{ app.name }}
            </button>
            }
        </div>
    </div>

    @if (selectedAppId()) {
    <!-- Summary Bar -->
    @if (summary(); as s) {
    <div class="summary-bar">
        <span class="summary-item">üìã {{ s.total }} Eintr√§ge</span>
        @if (s.accuracy !== null) {
        <span class="summary-item" [style.color]="getAccuracyColor(s.accuracy)">üéØ {{ s.accuracy }}% Genauigkeit</span>
        }
        @if (s.sparse > 0) {
        <span class="summary-item sparse">üß© {{ s.sparse }} unvollst√§ndig</span>
        }
        @if (s.flagged > 0) {
        <span class="summary-item flagged">üö© {{ s.flagged }} markiert</span>
        }
        @if (s.unverified > 0) {
        <span class="summary-item unverified">‚ö†Ô∏è {{ s.unverified }} ungepr√ºft</span>
        }
    </div>
    }

    <!-- Actions Bar -->
    <div class="actions-bar">
        <div class="actions-left">
            <button class="action-btn add-btn" (click)="toggleAddForm()">
                {{ showAddForm() ? '‚úï Abbrechen' : '+ Neuer Eintrag' }}
            </button>
            <button class="action-btn enhance-btn" (click)="toggleEnhancePanel()"
                    [class.active]="showEnhancePanel()">
                ü§ñ KI-Erweiterung
            </button>
            <button class="action-btn generate-btn" (click)="toggleGeneratePanel()"
                    [class.active]="showGeneratePanel()">
                ‚ú® Neue Eintr√§ge mit KI
            </button>
            <select class="sort-select" [ngModel]="sortBy()" (ngModelChange)="sortBy.set($event)">
                <option value="id">Sortierung: ID</option>
                <option value="completeness-asc">Vollst√§ndigkeit ‚Üë</option>
                <option value="completeness-desc">Vollst√§ndigkeit ‚Üì</option>
                <option value="accuracy-asc">Genauigkeit ‚Üë</option>
                <option value="accuracy-desc">Genauigkeit ‚Üì</option>
                <option value="flags">Markierungen ‚Üì</option>
            </select>
        </div>
        <span class="page-info">Seite {{ currentPage() }} / {{ totalPages() }} ({{ totalCount() }} total)</span>
    </div>

    <!-- AI Enhancement Panel -->
    @if (showEnhancePanel()) {
    <div class="enhance-panel">
        <h3>ü§ñ KI-gest√ºtzte Inhalts-Erweiterung</h3>

        <!-- Template Info -->
        @if (templateItem(); as tpl) {
        <div class="template-info">
            <span class="template-label">‚≠ê Vorlage:</span>
            <span class="template-preview">#{{ tpl.id }} ‚Äî {{ getPreview(tpl.data) }}</span>
            <span class="template-score">{{ tpl.depthScore }} Props</span>
        </div>
        } @else {
        <div class="template-warning">
            ‚ö†Ô∏è Keine Vorlage gew√§hlt. Klicke ‚≠ê auf einem Eintrag um ihn als Vorlage zu setzen.
        </div>
        }

        <!-- Custom Prompt -->
        <div class="prompt-section">
            <label>Anweisungen an die KI (app-spezifisch):</label>
            <textarea class="prompt-editor" rows="4"
                      [ngModel]="customPrompt()"
                      (ngModelChange)="customPrompt.set($event)"
                      placeholder="z.B. 'Nur bei unregelm√§ssigen Verben typicalMistakes hinzuf√ºgen...'"></textarea>
        </div>

        <!-- Batch Controls -->
        <div class="batch-controls">
            <div class="field-group">
                <label>Batch-Gr√∂sse:</label>
                <input type="number" [ngModel]="batchSize()" (ngModelChange)="batchSize.set($event)" min="1" max="10">
            </div>
            <span class="sparse-count">{{ sparseEntries().length }} unvollst√§ndige Eintr√§ge</span>
            <button class="save-btn" (click)="runEnhanceBatch()"
                    [disabled]="enhancing() || !templateItem() || sparseEntries().length === 0">
                @if (enhancing()) {
                    @if (enhanceProgress(); as p) {
                    <span>‚è≥ {{ p.current }}/{{ p.total }}...</span>
                    } @else {
                    <span>‚è≥ Starte...</span>
                    }
                } @else {
                <span>üöÄ N√§chsten Batch erweitern</span>
                }
            </button>
        </div>

        <!-- Enhancement Results -->
        @if (enhanceResults().length > 0) {
        <div class="enhance-results">
            <h4>Ergebnisse ‚Äî Pr√ºfen & √úbernehmen</h4>
            @for (r of enhanceResults(); track r.id) {
            <div class="result-card" [class.accepted]="isAccepted(r.id)" [class.rejected]="isRejected(r.id)">
                <div class="result-header">
                    <span class="result-id">#{{ r.id }}</span>
                    <span class="result-preview">{{ getPreview(r.original) }}</span>
                    @if (r.error) {
                    <span class="result-error">‚ùå {{ r.error }}</span>
                    } @else {
                    <span class="result-diff">+{{ getEnhancedDiffKeys(r).length }} Felder</span>
                    }
                </div>
                @if (r.enhanced && !r.error) {
                <div class="result-body">
                    <div class="result-col">
                        <h5>Vorher</h5>
                        <pre class="diff-pre">{{ r.original | json }}</pre>
                    </div>
                    <div class="result-col">
                        <h5>Nachher (KI)</h5>
                        @if (editingEnhancedId() === r.id) {
                        <textarea class="json-editor" rows="14"
                                  [ngModel]="editingEnhancedJson()"
                                  (ngModelChange)="editingEnhancedJson.set($event)"></textarea>
                        <div class="edit-actions" style="margin-top:6px;">
                            <button class="save-btn" (click)="saveEditEnhanced(r)">‚úì √úbernehmen</button>
                            <button class="cancel-btn" (click)="cancelEditEnhanced()">Abbrechen</button>
                        </div>
                        } @else {
                        <pre class="diff-pre enhanced">{{ r.enhanced | json }}</pre>
                        }
                    </div>
                </div>
                <div class="result-actions">
                    @if (editingEnhancedId() !== r.id) {
                    <button class="action-btn accept-btn" (click)="acceptResult(r)" [class.active]="isAccepted(r.id)">
                        ‚úì √úbernehmen
                    </button>
                    <button class="action-btn edit-enhanced-btn" (click)="startEditEnhanced(r)">
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    <button class="action-btn reject-btn" (click)="rejectResult(r)" [class.active]="isRejected(r.id)">
                        ‚úï Ablehnen
                    </button>
                    }
                </div>
                }
            </div>
            }

            <!-- Save All Accepted -->
            @if (acceptedIds().size > 0) {
            <div class="save-accepted-bar">
                <button class="save-btn" (click)="saveAcceptedEnhancements()" [disabled]="savingEnhanced()">
                    {{ savingEnhanced() ? 'Speichert...' : 'üíæ ' + acceptedIds().size + ' √Ñnderungen speichern' }}
                </button>
            </div>
            }
        </div>
        }
    </div>
    }

    <!-- Generate New Content Panel -->
    @if (showGeneratePanel()) {
    <div class="enhance-panel generate-panel">
        <h3>‚ú® Neue Eintr√§ge mit KI erstellen</h3>
        <p class="panel-desc">Die KI kennt alle bestehenden Eintr√§ge und generiert neue, einzigartige Inhalte.</p>

        <div class="prompt-section">
            <label>Anweisungen an die KI (optional):</label>
            <textarea class="prompt-editor" rows="3"
                      [ngModel]="generatePrompt()"
                      (ngModelChange)="generatePrompt.set($event)"
                      placeholder="z.B. 'Erstelle Eintr√§ge zu Tier-Themen' oder 'Schwierigkeitsgrad soll hoch sein'"></textarea>
        </div>

        <div class="batch-controls">
            <div class="field-group">
                <label>Anzahl:</label>
                <input type="number" [ngModel]="generateCount()" (ngModelChange)="generateCount.set($event)" min="1" max="20">
            </div>
            <button class="save-btn" (click)="runGenerate()"
                    [disabled]="generating()">
                @if (generating()) {
                <span>‚è≥ KI generiert...</span>
                } @else {
                <span>üöÄ Generieren</span>
                }
            </button>
        </div>

        <!-- Generate Results -->
        @if (generateResults().length > 0) {
        <div class="enhance-results">
            <h4>{{ generateResults().length }} neue Eintr√§ge ‚Äî Pr√ºfen & √úbernehmen</h4>
            @for (entry of generateResults(); track $index) {
            <div class="result-card"
                 [class.accepted]="isGenerateAccepted($index)"
                 [class.rejected]="isGenerateRejected($index)">
                <div class="result-header">
                    <span class="result-id">Neu {{ $index + 1 }}</span>
                    <span class="result-preview">{{ getPreview(entry) }}</span>
                </div>
                <div class="result-body" style="flex-direction:column;">
                    @if (editingGenerateIdx() === $index) {
                    <textarea class="json-editor" rows="14"
                              [ngModel]="editingGenerateJson()"
                              (ngModelChange)="editingGenerateJson.set($event)"></textarea>
                    <div class="edit-actions" style="margin-top:6px;">
                        <button class="save-btn" (click)="saveEditGenerate($index)">‚úì √úbernehmen</button>
                        <button class="cancel-btn" (click)="cancelEditGenerate()">Abbrechen</button>
                    </div>
                    } @else {
                    <pre class="diff-pre enhanced">{{ entry | json }}</pre>
                    }
                </div>
                <div class="result-actions">
                    @if (editingGenerateIdx() !== $index) {
                    <button class="action-btn accept-btn" (click)="acceptGenerate($index)" [class.active]="isGenerateAccepted($index)">
                        ‚úì √úbernehmen
                    </button>
                    <button class="action-btn edit-enhanced-btn" (click)="startEditGenerate($index)">
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    <button class="action-btn reject-btn" (click)="rejectGenerate($index)" [class.active]="isGenerateRejected($index)">
                        ‚úï Ablehnen
                    </button>
                    }
                </div>
            </div>
            }

            <!-- Save All Accepted Generated -->
            @if (acceptedGenerateIdxs().size > 0) {
            <div class="save-accepted-bar">
                <button class="save-btn" (click)="saveAcceptedGenerated()" [disabled]="savingGenerated()">
                    {{ savingGenerated() ? 'Speichert...' : 'üíæ ' + acceptedGenerateIdxs().size + ' neue Eintr√§ge speichern' }}
                </button>
            </div>
            }
        </div>
        }
    </div>
    }

    <!-- Add Form -->
    @if (showAddForm()) {
    <div class="edit-panel add-panel">
        <h3>Neuer Eintrag f√ºr {{ selectedAppId() }}</h3>
        <div class="edit-fields">
            <div class="field-group">
                <label>Level (optional)</label>
                <input type="number" [ngModel]="addLevel()" (ngModelChange)="addLevel.set($event)" min="1" max="10" placeholder="‚Äî">
            </div>
        </div>
        <textarea class="json-editor" rows="10" [ngModel]="addJson()" (ngModelChange)="addJson.set($event)"></textarea>
        @if (jsonError()) {
        <div class="json-error">{{ jsonError() }}</div>
        }
        <div class="edit-actions">
            <button class="save-btn" (click)="addContent()" [disabled]="saving()">
                {{ saving() ? 'Speichert...' : '‚úì Hinzuf√ºgen' }}
            </button>
        </div>
    </div>
    }

    <!-- Success Message -->
    @if (successMsg()) {
    <div class="success-toast">{{ successMsg() }}</div>
    }

    <!-- Loading -->
    @if (loading()) {
    <div class="loading-state">Laden...</div>
    }

    <!-- Error -->
    @if (error()) {
    <div class="error-state">{{ error() }}</div>
    }

    <!-- Content Table -->
    @if (!loading() && items().length > 0) {
    <div class="content-table">
        @for (item of sortedItems(); track item.id) {
        <div class="content-row"
             [class.flagged]="item.flagCounter > 0"
             [class.editing]="editingId() === item.id"
             [class.is-template]="templateId() === item.id"
             [class.sparse]="(item.completeness ?? 100) < 80">
            <!-- Row Header -->
            <div class="row-header">
                <div class="row-id">#{{ item.id }}</div>
                <div class="row-preview">{{ getPreview(item.data) }}</div>

                <!-- Completeness Bar -->
                <div class="completeness-cell" [title]="'Vollst√§ndigkeit: ' + (item.completeness ?? 100) + '% (' + (item.depthScore ?? 0) + ' Props)'">
                    <div class="completeness-bar">
                        <div class="completeness-fill"
                             [style.width.%]="item.completeness ?? 100"
                             [style.background]="getCompletenessColor(item.completeness ?? 100)"></div>
                    </div>
                    <span class="completeness-pct" [style.color]="getCompletenessColor(item.completeness ?? 100)">
                        {{ item.completeness ?? 100 }}%
                    </span>
                </div>

                <div class="row-badges">
                    @if (templateId() === item.id) {
                    <span class="badge badge-template" title="Vorlage">‚≠ê</span>
                    }
                    @if (item.flagCounter > 0) {
                    <span class="badge badge-flag" title="Markierungen">üö© {{ item.flagCounter }}</span>
                    }
                    @if (item.aiGenerated) {
                    <span class="badge badge-ai" title="KI-generiert">ü§ñ</span>
                    }
                    @if (!item.humanVerified) {
                    <span class="badge badge-unverified" title="Nicht verifiziert">‚ö†Ô∏è</span>
                    }
                    @if (item.level) {
                    <span class="badge badge-level" title="Level">Lv{{ item.level }}</span>
                    }
                </div>
                <div class="row-stats">
                    @if (item.stats.totalAttempts > 0) {
                    <span class="stat-accuracy" [style.color]="getAccuracyColor(item.stats.accuracy)">
                        {{ item.stats.accuracy }}%
                    </span>
                    <span class="stat-detail">
                        {{ item.stats.totalCorrect }}/{{ item.stats.totalAttempts }}
                        ({{ item.stats.uniqueUsers }} üë§)
                    </span>
                    } @else {
                    <span class="stat-none">‚Äî</span>
                    }
                </div>
                <div class="row-actions">
                    <button class="icon-btn template-btn" (click)="setAsTemplate(item)" title="Als Vorlage setzen"
                            [class.active]="templateId() === item.id">‚≠ê</button>
                    <button class="icon-btn edit-btn" (click)="startEdit(item)" title="Bearbeiten">‚úèÔ∏è</button>
                    <button class="icon-btn delete-btn" (click)="deleteItem(item)" title="L√∂schen">üóëÔ∏è</button>
                </div>
            </div>

            <!-- Inline Editor -->
            @if (editingId() === item.id) {
            <div class="edit-panel">
                <div class="edit-fields">
                    <div class="field-group">
                        <label>Level</label>
                        <input type="number" [ngModel]="editLevel()" (ngModelChange)="editLevel.set($event)" min="1" max="10" placeholder="‚Äî">
                    </div>
                </div>
                <textarea class="json-editor" rows="14" [ngModel]="editJson()" (ngModelChange)="editJson.set($event)"></textarea>
                @if (jsonError()) {
                <div class="json-error">{{ jsonError() }}</div>
                }
                <div class="edit-actions">
                    <button class="save-btn" (click)="saveEdit()" [disabled]="saving()">
                        {{ saving() ? 'Speichert...' : '‚úì Speichern' }}
                    </button>
                    <button class="cancel-btn" (click)="cancelEdit()">Abbrechen</button>
                </div>
            </div>
            }
        </div>
        }
    </div>

    <!-- Pagination -->
    @if (totalPages() > 1) {
    <div class="pagination">
        <button class="page-btn" (click)="goToPage(currentPage() - 1)" [disabled]="currentPage() === 1">‚Üê Zur√ºck</button>
        @for (p of [].constructor(totalPages()); track $index) {
        <button class="page-btn" [class.active]="currentPage() === $index + 1" (click)="goToPage($index + 1)">
            {{ $index + 1 }}
        </button>
        }
        <button class="page-btn" (click)="goToPage(currentPage() + 1)" [disabled]="currentPage() === totalPages()">Weiter ‚Üí</button>
    </div>
    }
    }

    <!-- Empty State -->
    @if (!loading() && items().length === 0 && selectedAppId()) {
    <div class="empty-state">Keine Inhalte f√ºr diese App.</div>
    }
    }
</div>
