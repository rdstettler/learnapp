<div class="lehrplan-container">
    <!-- Header -->
    <div class="header">
        <button class="back-btn" (click)="goBack()">‚Üê Zur√ºck</button>
        <h1>üìò Lehrplan 21</h1>
        <p class="subtitle">{{zyklusLabel()}}</p>
    </div>

    <!-- Fachbereich Tabs -->
    <div class="tabs">
        <button class="tab" [class.active]="activeFachbereich() === 'deutsch'" (click)="setFachbereich('deutsch')">
            üìñ Deutsch
        </button>
        <button class="tab" [class.active]="activeFachbereich() === 'mathematik'"
            (click)="setFachbereich('mathematik')">
            üî¢ Mathematik
        </button>
    </div>

    <!-- Loading -->
    @if (loading()) {
    <div class="loading">
        <div class="spinner"></div>
        <p>Lehrplan wird geladen...</p>
    </div>
    }

    <!-- Error -->
    @if (error()) {
    <div class="error-msg">{{error()}}</div>
    }

    <!-- Tree -->
    @if (!loading() && !error()) {

    <!-- Admin Bar -->
    @if (isAdmin()) {
    <div class="admin-bar">
        <label class="toggle">
            <input type="checkbox" [checked]="editMode()" (change)="toggleEditMode()">
            <span class="slider"></span>
            Admin Mode (Edit Links)
        </label>
    </div>
    }

    <div class="tree">
        @for (node of tree(); track node.code) {
        <ng-container *ngTemplateOutlet="treeNode; context: { $implicit: node, depth: 0 }"></ng-container>
        }
    </div>
    }

    <!-- Modal -->
    @if (showModal()) {
    <div class="modal-backdrop" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>{{ isEditingExisting() ? 'Link bearbeiten' : 'App verkn√ºpfen' }}</h3>

            <div class="form-group">
                <label>Node:</label>
                <div class="node-preview">{{selectedNode()?.code}} - {{selectedNode()?.title}}</div>
            </div>

            <div class="form-group">
                <label>App:</label>
                <select [value]="selectedAppId()" (change)="setAppId($any($event.target).value)"
                    [disabled]="isEditingExisting()">
                    @for (app of availableApps(); track app.id) {
                    <option [value]="app.id">{{app.name}} ({{app.id}})</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Konfiguration (JSON):</label>
                <textarea [value]="jsonConfig()" (input)="setConfig($any($event.target).value)" rows="5"></textarea>
                <small class="hint">
                    G√ºltige Parameter:
                    <br>- Kopfrechnen: &#123; "addMax": 20, "subMax": 20, "operations": ["add", "sub"] &#125;
                    <br>- Textaufgaben: &#123; "level": 1 &#125;
                </small>
            </div>

            <div class="modal-actions">
                <button (click)="closeModal()" class="cancel-btn">Abbrechen</button>
                <button (click)="saveLink()" class="save-btn">Speichern</button>
            </div>
        </div>
    </div>
    }
</div>

<!-- Recursive tree template -->
<ng-template #treeNode let-node let-depth="depth">
    <div class="node" [class]="'node-' + node.level" [style.padding-left.px]="depth * 16 + 8">
        <!-- Node header -->
        <div class="node-header" (click)="!editMode() && node.children.length ? toggleNode(node) : null"
            [class.expandable]="node.children.length > 0" [class.leaf]="node.children.length === 0">

            @if (node.children.length > 0) {
            <span class="expand-icon" (click)="editMode() ? toggleNode(node) : null">{{node.expanded ? '‚ñæ' :
                '‚ñ∏'}}</span>
            } @else {
            <span class="expand-icon leaf-dot">¬∑</span>
            }

            <span class="node-icon">{{getLevelIcon(node.level)}}</span>

            <div class="node-content">
                <span class="node-code">{{node.code}}</span>
                <span class="node-title">{{node.title}}</span>

                @if (node.zyklus) {
                <span class="zyklus-badge">Z{{node.zyklus}}</span>
                }

                @if (node.mastery !== undefined && node.mastery > 0) {
                <span class="mastery-badge" [class.completed]="node.mastery >= 100"
                    [title]="'Mastery: ' + node.mastery + '%'">
                    {{node.mastery >= 100 ? '‚≠ê' : node.mastery + '%'}}
                </span>
                }
            </div>

            <!-- App chips -->
            <div class="app-chips">
                @if (node.apps && node.apps.length > 0) {
                @for (config of node.appConfigs; track config.appId) {
                <button class="app-chip" [class.direct-link]="config._isDirect"
                    (click)="editMode() && config._isDirect ? openEditModal(node, config.appId, config) : navigateToApp(config.appId, node.id, config); $event.stopPropagation()">
                    <span class="icon">{{getAppInfo(config.appId).icon}}</span>
                    <span class="name">{{getAppInfo(config.appId).name}}</span>
                    @if (editMode()) {
                    @if (config._isDirect) { <span class="edit-badge">‚úé</span> }
                    @else { <span class="inherit-badge">‚Ü≥</span> }
                    }
                </button>
                <!-- Removing separate delete button to keep UI clean, edit modal has delete? Or add delete btn? -->
                <!-- Let's add delete X if direct link -->
                @if (editMode() && config._isDirect) {
                <span class="delete-x" (click)="removeLink(node, config.appId); $event.stopPropagation()">√ó</span>
                }
                }
                }

                @if (editMode()) {
                <button class="add-btn" (click)="openAddModal(node); $event.stopPropagation()">+</button>
                }
            </div>
        </div>

        <!-- Description and Children ... -->
        @if (node.level === 'kompetenzstufe' && node.description) {
        <div class="node-description" [style.padding-left.px]="depth * 16 + 48">
            {{node.description}}
        </div>
        }

        @if (node.expanded && node.children.length > 0) {
        @for (child of node.children; track child.code) {
        <ng-container *ngTemplateOutlet="treeNode; context: { $implicit: child, depth: depth + 1 }"></ng-container>
        }
        }
    </div>
</ng-template>