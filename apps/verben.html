<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Verben-Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <style>
        /* App-specific: max-width override */
        .app {
            max-width: 600px;
        }

        .question-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .verb-badge {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-radius: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .tense-badge {
            display: inline-block;
            padding: 6px 14px;
            background: rgba(217, 70, 239, 0.2);
            border: 1px solid rgba(217, 70, 239, 0.4);
            border-radius: 12px;
            font-size: 0.9rem;
            color: var(--accent-3);
        }

        .question-list {
            flex: 1;
        }

        .question-item {
            margin-bottom: 20px;
        }

        .question-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .person-badge {
            padding: 4px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 500;
        }

        .answer-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--accent-1);
        }

        .answer-input.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .answer-input.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .correction {
            margin-top: 6px;
        }
    </style>
</head>

<body>
    <div class="bg-animation"></div>

    <div class="app">
        <header class="header">
            <h1>üìö Verben-Quiz</h1>
        </header>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="card">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="welcome-container">
                <div class="welcome-emoji">‚úçÔ∏è</div>
                <h2 style="margin-bottom: 10px;">Verben Konjugation</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    Teste dein Wissen! 5 Runden mit je 3 verschiedenen Verben.
                </p>
                <button class="btn btn-primary" id="startBtn">Quiz starten</button>
            </div>

            <!-- Quiz Screen -->
            <div id="quizScreen" class="hidden">
                <div class="question-header">
                    <h3 style="color: var(--text-secondary); font-size: 0.9rem;">Runde <span id="roundDisplay">1</span>
                        / 5</h3>
                </div>
                <div class="question-list" id="questionList"></div>
                <button class="btn btn-primary" id="checkBtn">√úberpr√ºfen</button>
                <button class="btn btn-primary hidden" id="nextBtn">Weiter</button>
            </div>

            <!-- Results Screen -->
            <div id="resultsScreen" class="hidden">
                <div class="score-display">
                    <div class="score-circle" id="finalScore">-</div>
                    <p class="score-text" id="scoreText">Quiz abgeschlossen!</p>
                    <div class="score-breakdown">
                        <div class="score-item correct">
                            <div class="score-item-number" id="correctCount">0</div>
                            <div class="score-item-label">Richtig</div>
                        </div>
                        <div class="score-item wrong">
                            <div class="score-item-number" id="wrongCount">0</div>
                            <div class="score-item-label">Falsch</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" id="restartBtn">Nochmal spielen</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let data = null;
        let rounds = [];
        let currentRoundIndex = 0;
        let totalCorrect = 0;
        let totalQuestions = 0;

        const tenseNames = {
            praeteritum: 'Pr√§teritum',
            perfekt: 'Perfekt',
            plusquamperfekt: 'Plusquamperfekt'
        };

        const persons = ['ich', 'du', 'er/sie/es', 'wir', 'ihr', 'sie/Sie'];
        const tenses = ['praeteritum', 'perfekt', 'plusquamperfekt'];

        // Load data
        fetch('verben.json')
            .then(res => res.json())
            .then(json => {
                data = json;
                document.getElementById('startBtn').disabled = false;
            })
            .catch(err => console.error('Error:', err));

        // Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const progressFill = document.getElementById('progressFill');
        const questionList = document.getElementById('questionList');
        const checkBtn = document.getElementById('checkBtn');
        const nextBtn = document.getElementById('nextBtn');

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startQuiz);
        checkBtn.addEventListener('click', checkAnswers);
        nextBtn.addEventListener('click', nextRound);
        document.getElementById('restartBtn').addEventListener('click', restartQuiz);

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function generateRounds() {
            rounds = [];
            // For 5 rounds, each with 3 questions (different verb/person/tense)
            for (let r = 0; r < 5; r++) {
                const roundQuestions = [];
                const usedVerbs = new Set();
                const usedPersons = new Set();
                const usedTenses = new Set();

                // Pick 3 unique combinations
                const shuffledVerbs = shuffle(data.verbs);
                const shuffledPersons = shuffle(persons);
                const shuffledTenses = shuffle(tenses);

                for (let q = 0; q < 3; q++) {
                    const verb = shuffledVerbs[q];
                    const person = shuffledPersons[q];
                    const tense = shuffledTenses[q];

                    roundQuestions.push({
                        verb: verb.verb,
                        person: person,
                        tense: tense,
                        answer: verb[tense][person]
                    });
                }

                rounds.push(roundQuestions);
            }

            totalQuestions = 15; // 5 rounds √ó 3 questions
        }

        function startQuiz() {
            generateRounds();
            currentRoundIndex = 0;
            totalCorrect = 0;

            welcomeScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');

            showRound();
        }

        function showRound() {
            const round = rounds[currentRoundIndex];
            const progress = (currentRoundIndex / rounds.length) * 100;
            progressFill.style.width = `${progress}%`;

            document.getElementById('roundDisplay').textContent = currentRoundIndex + 1;

            questionList.innerHTML = round.map((q, i) => `
                <div class="question-item">
                    <div class="question-label">
                        <span class="verb-badge" style="font-size: 1rem; padding: 6px 14px;">${q.verb}</span>
                        <span class="person-badge">${q.person}</span>
                        <span class="tense-badge">${tenseNames[q.tense]}</span>
                    </div>
                    <input type="text" 
                           class="answer-input" 
                           id="answer-${i}" 
                           data-answer="${q.answer}"
                           data-person="${q.person}"
                           placeholder="Antwort eingeben..."
                           autocomplete="off"
                           autocapitalize="off">
                    <div class="correction hidden" id="correction-${i}"></div>
                </div>
            `).join('');

            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');

            // Focus first input
            setTimeout(() => document.getElementById('answer-0')?.focus(), 100);
        }

        function normalizeAnswer(str) {
            return str.trim().toLowerCase();
        }

        function checkAnswers() {
            const round = rounds[currentRoundIndex];

            round.forEach((q, i) => {
                const input = document.getElementById(`answer-${i}`);
                const correction = document.getElementById(`correction-${i}`);
                const userAnswer = normalizeAnswer(input.value);
                const correctAnswer = normalizeAnswer(q.answer);

                // Get pronoun from person (first part before /)
                const pronoun = q.person.split('/')[0].toLowerCase();

                // Accept both "hatte geboten" and "er hatte geboten"
                const answerWithoutPronoun = correctAnswer.replace(pronoun + ' ', '');
                const userWithoutPronoun = userAnswer.replace(pronoun + ' ', '');

                const isCorrect =
                    userAnswer === correctAnswer ||
                    userAnswer === answerWithoutPronoun ||
                    userWithoutPronoun === answerWithoutPronoun;

                if (isCorrect) {
                    input.classList.add('correct');
                    totalCorrect++;
                } else {
                    input.classList.add('incorrect');
                    correction.textContent = `Richtig: ${q.answer}`;
                    correction.classList.remove('hidden');
                }

                input.disabled = true;
            });

            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
        }

        function nextRound() {
            currentRoundIndex++;

            if (currentRoundIndex >= rounds.length) {
                showResults();
            } else {
                showRound();
            }
        }

        function showResults() {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            progressFill.style.width = '100%';

            const percentage = Math.round((totalCorrect / totalQuestions) * 100);
            document.getElementById('finalScore').textContent = `${percentage}%`;
            document.getElementById('scoreText').textContent = `${totalCorrect} von ${totalQuestions} richtig!`;
            document.getElementById('correctCount').textContent = totalCorrect;
            document.getElementById('wrongCount').textContent = totalQuestions - totalCorrect;
        }

        function restartQuiz() {
            resultsScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            progressFill.style.width = '0%';
        }
    </script>
</body>

</html>